<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Daily Check-in</title>
  <style>
    :root{
      --bg1:#edede9; --bg2:#d6ccc2; --card:#f5ebe0; --border:#e3d5ca;
      --text:#7c6f57; --accent:#d5bdaf; --error:#b00020; --success:#2e7d32;
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
      color:#4a4436;
      padding:1rem;
    }

    /* Add fade-in animation */
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header */
    header{
      max-width: 820px;
      margin: 0 auto 1rem auto;
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding: .9rem 1.1rem;
      box-shadow: 0 4px 18px rgba(213,189,175,.18);
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap:.75rem;
    }
    .h-left{
      display:flex; align-items:center; gap:1rem;
    }
    h2{
      margin:0; color: var(--accent); font-size:1.6rem; font-weight:800;
    }
    #currentDate{ margin:0; color:#a08c7a; font-style: italic; }

    /* Card / Form */
    .wrap{ max-width: 520px; margin: 0 auto; }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: 0 4px 24px rgba(213,189,175,.15);
      padding: 1.5rem;
    }
    form{ margin-top:.25rem; }
    label{ display:block; margin-top:1rem; color: var(--text); font-weight:700; }
    .control{ margin-top:.5rem; }
    select, input[type="number"], input[type="text"], input[type="date"]{
      width:100%; padding:.8rem .9rem; border-radius:10px; border:1px solid var(--border);
      background:#edede9; font-size:1rem; color:#4a4436; outline:none;
      transition: border-color .2s, box-shadow .2s, background .2s;
    }
    select:focus, input:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(213,189,175,.25);
      background:#fff;
    }

    .hint{ color:#a08c7a; font-size:.9rem; margin-top:.4rem; }

    .actions{ margin-top:1.2rem; display:flex; flex-direction:column; gap:.6rem; }
    .btn{
      width:100%; background: var(--border); color: var(--text);
      border:none; border-radius:10px; padding:.9rem 1.2rem;
      font-size:1.05rem; font-weight:800; cursor:pointer;
      transition: background .2s ease, transform .04s ease;
      box-shadow: 0 2px 8px rgba(213,189,175,.10);
    }
    .btn:hover{ background: var(--bg2); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .btn-secondary{
      background:#e3d5ca; border:1px solid var(--bg2);
      font-weight:700;
    }
    .btn-secondary:hover{ background: var(--bg2); }

    #result{ margin-top:.9rem; }
    .success, .error{
      padding:.75rem .9rem; border-radius:10px; font-weight:700;
      border:1px solid transparent;
    }
    .success{ color: var(--success); background:#eaf4ea; border-color:#cde6cd; }
    .error{ color: var(--error); background:#fdeced; border-color:#f5c2c7; }
    .invalid{ border-color: var(--error) !important; box-shadow: 0 0 0 3px rgba(176,0,32,.15) !important; }

    /* Modal */
    .overlay{
      display:none; position:fixed; inset:0; background: rgba(0,0,0,.35); z-index:1000;
    }
    .modal{
      position:fixed; top:50%; left:50%; transform: translate(-50%, -50%);
      background: #fff; border:1px solid var(--border); border-radius:16px;
      box-shadow: 0 8px 32px rgba(0,0,0,.25);
      padding: 1.2rem 1.2rem 1rem 1.2rem; width:min(92vw, 380px); z-index:1001;
      text-align:center;
    }
    .modal h3{ margin:.2rem 0 .6rem 0; color: var(--text); }
    .modal p{ margin:.25rem 0 .9rem 0; color:#6b6456; }
  </style>
</head>
<body class="fade-in">
  <!-- Header -->
  <header>
    <div class="h-left">
      <h2>Daily Check-in</h2>
    </div>
    <p id="currentDate"></p>
  </header>

  <!-- Card -->
  <div class="wrap">
    <div class="card">
      <form id="checkinForm" novalidate>
        <input type="hidden" name="user_id" id="user_id" value="123" />

        <label for="mood">How are you feeling today?</label>
        <div class="control">
          <select name="mood" id="mood" required>
            <option value="">Select your mood</option>
            <option value="1">üò¢ 1 - Extremely Horrible</option>
            <option value="2">üòü 2 - Very Bad</option>
            <option value="3">üòï 3 - Bad</option>
            <option value="4">üòê 4 - Below Average</option>
            <option value="5">üôÇ 5 - Average</option>
            <option value="6">üòä 6 - Slightly Good</option>
            <option value="7">üòÅ 7 - Good</option>
            <option value="8">üòÅ 8 - Very Good</option>
            <option value="9">üòÑ 9 - Excellent</option>
            <option value="10">ü§© 10 - Outstanding</option>
          </select>
        </div>

        <label for="screen_time_in_minutes">What is your screen time for the day?</label>
        <div class="control">
          <input type="number" name="screen_time_in_minutes" id="screen_time_in_minutes"
                 placeholder="e.g., 1.5 hours"
                 step="0.1" min="0" max="24" required inputmode="decimal" />
          <div class="hint">Enter total hours (e.g., 2.5 = 2 hours 30 minutes). If you enter 24, decimals aren‚Äôt allowed.</div>
        </div>

        <label for="entry_date">What is the date today?</label>
        <div class="control">
          <input type="date" name="entry_date" id="entry_date" required />
        </div>

        <script>
          // Set default date to today
          const dateInput = document.getElementById('entry_date');
          const todayDate = new Date().toISOString().split('T')[0];
          dateInput.value = todayDate;
        </script>

        <div class="actions">
          <button type="submit" class="btn" id="submitBtn">Submit</button>
        </div>

        <div id="result" role="alert" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="overlay" id="overlay"></div>
  <div class="modal" id="successModal" style="display:none;">
    <h3>‚úÖ Check-in saved</h3>
    <p>Great job staying consistent today.</p>
    <button class="btn" id="closePopup">Continue</button>
  </div>

  <script>
    // Date display
    const currentDateElement = document.getElementById('currentDate');
    const today = new Date();
    currentDateElement.textContent = today.toLocaleDateString('en-US',
      { weekday:'long', year:'numeric', month:'long', day:'numeric' });

    // Helpers
    const form = document.getElementById('checkinForm');
    const resultBox = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');
    const overlay = document.getElementById('overlay');
    const modal = document.getElementById('successModal');

    function showError(msg){ resultBox.className='error'; resultBox.textContent=msg; }
    function showSuccess(msg){ resultBox.className='success'; resultBox.textContent=msg; }
    function clearMsgs(){ resultBox.className=''; resultBox.textContent=''; }
    function openModal(){
      overlay.style.display='block';
      modal.style.display='block';
    }
    function closeModal(){
      overlay.style.display='none';
      modal.style.display='none';
    }

    // Validation: Ensure screen time is a valid number between 0 and 24
    function validHours(val) {
      return !Number.isNaN(val) && val >= 0 && val <= 24;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMsgs();

      const userId = document.getElementById('user_id').value.trim();
      const moodStr = document.getElementById('mood').value;
      const screenTimeInput = document.getElementById('screen_time_in_minutes');
      const screenTimeVal = parseFloat(screenTimeInput.value);
      const entryDate = document.getElementById('entry_date').value;

      console.log('Form Values:', { userId, moodStr, screenTimeVal }); // Debugging log

      // Frontend checks
      if (!userId){
        showError('Missing user ID.');
        return;
      }
      if (!moodStr){
        showError('Please select your mood.');
        document.getElementById('mood').classList.add('invalid');
        return;
      } else {
        document.getElementById('mood').classList.remove('invalid');
      }
      if (!validHours(screenTimeVal)){
        showError('Enter a valid screen time between 0 and 24 hours.');
        screenTimeInput.classList.add('invalid');
        return;
      } else {
        screenTimeInput.classList.remove('invalid');
      }

      // Build payload (send number types + raw string if needed)
      const payload = {
        user_id: userId,
        mood: Number(moodStr),
        screen_time_in_minutes: Math.round(screenTimeVal * 60), // Ensure minutes are sent
        entry_date: entryDate // Include entry_date in the payload
      };

      console.log('Payload being sent to backend:', payload); // Debugging log

      try{
        submitBtn.disabled = true;
        showSuccess('Saving your check-in‚Ä¶');

        const token = localStorage.getItem('token'); // Retrieve JWT token from localStorage
        if (!token) {
          showError('You are not logged in. Please log in again.');
          submitBtn.disabled = false;
          return;
        }

        const res = await fetch('/api/checkin', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}` // Include Authorization header
          },
          body: JSON.stringify(payload)
        });

        let result = {};
        try { result = await res.json(); } catch {}

        if (res.ok){
          showSuccess('Check-in saved!');
          openModal();
        } else {
          showError(result.error || 'Error saving check-in.');
          submitBtn.disabled = false;
        }
      }catch(err){
        showError('Network error. Please try again.');
        submitBtn.disabled = false;
      }
    });

    // Modal actions
    document.getElementById('closePopup').addEventListener('click', () => {
      closeModal();
      window.location.href = '/reflection.html'; // Redirect to reflection page
    });
    overlay.addEventListener('click', closeModal);
  </script>
</body>
</html>